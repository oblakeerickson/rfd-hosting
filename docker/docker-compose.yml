# RFD Docker Compose Configuration
#
# For local builds on the server, use the build: sections as-is.
# For pre-built images (recommended), comment out "build:" and uncomment "image:":
#   # build:
#   #   context: .
#   #   dockerfile: Dockerfile
#   image: rfd-api:latest

services:
  # PostgreSQL database
  # Enable with: docker compose --profile db up -d
  postgres:
    image: postgres:14
    container_name: rfd-postgres
    restart: unless-stopped
    profiles:
      - db
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: rfd
      POSTGRES_USER: rfd
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    networks:
      - rfd-network

  rfd-api:
    # For pre-built images, comment out build: and use:
    # image: rfd-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rfd-api
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./config/config.toml:/app/rfd-api/config.toml:ro
      - ./config/mappers.toml:/app/rfd-api/mappers.toml:ro
    environment:
      - DATABASE_URL=postgres://rfd:${DB_PASSWORD}@postgres:5432/rfd
      - GITHUB_WEBHOOK_KEY=${GITHUB_WEBHOOK_KEY}
    command: ["rfd-api"]
    networks:
      - rfd-network

  rfd-processor:
    # For pre-built images, comment out build: and use:
    # image: rfd-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rfd-processor
    restart: unless-stopped
    volumes:
      - ./config/processor-config.toml:/app/rfd-processor/config.toml:ro
    environment:
      - DATABASE_URL=postgres://rfd:${DB_PASSWORD}@postgres:5432/rfd
    command: ["rfd-processor"]
    depends_on:
      - rfd-api
    networks:
      - rfd-network

  # rfd-site frontend
  # Enable with: docker compose --profile frontend up -d
  rfd-site:
    # For pre-built images, comment out build: and use:
    # image: rfd-site:latest
    build:
      context: .
      dockerfile: Dockerfile.site
    container_name: rfd-site
    restart: unless-stopped
    profiles:
      - frontend
    environment:
      # RFD_API must be the PUBLIC URL, not internal docker hostname
      - RFD_API=${RFD_API}
      - RFD_API_CLIENT_ID=${RFD_API_CLIENT_ID}
      - RFD_API_CLIENT_SECRET=${RFD_API_CLIENT_SECRET}
      - RFD_API_GITHUB_CALLBACK_URL=${RFD_API_GITHUB_CALLBACK_URL}
      - SESSION_SECRET=${SESSION_SECRET}
    depends_on:
      - rfd-api
    networks:
      - rfd-network

  caddy:
    image: caddy:2-alpine
    container_name: rfd-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - rfd-api
    networks:
      - rfd-network

networks:
  rfd-network:
    driver: bridge

volumes:
  caddy_data:
  caddy_config:
  pgdata:
